using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;

namespace ${NAMESPACE}
{
	public class ${CLASS_NAME}
	{
		public static async Task<${RETURN_TYPE}> InvokeAsync(DbConnection connection, DbTransaction transaction, ${PARAMETER_TYPE} parameter)
		{
			var command = connection.CreateCommand();
            command.Connection = connection;
            command.Transaction = transaction;
			const string commandLocation = "${COMMAND_LOCATION}";
            var stream = Assembly.GetExecutingAssembly().GetManifestResourceStream(commandLocation) ?? throw new InvalidOperationException($"SQL resource not found: {commandLocation}");
            using var streamReader = new StreamReader(stream);
            command.CommandText = await streamReader.ReadToEndAsync();
            command.CommandTimeout = 60;

			${PARAMETERS_PLACEHOLDER}

			var results = new List<${RESULT_TYPE}_Raw>();
            await using var reader = await command.ExecuteReaderAsync();

			try
			{
				while (await reader.ReadAsync())
				{
					var resultItem = new ${RESULT_TYPE}_Raw();

					${READER_ITEMS}

					results.Add(resultItem);
				}

				reader.Close();
			}
			catch(Exception ex)
			{
				reader.Close();

                throw;
			}

			${RETURN_PLACEHOLDER}

            return result;
		}

		${RAW_CLASS}
	}

	${CUSTOM_CLASSES}
}